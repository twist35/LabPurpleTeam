---
- name: Mettre à jour le cache APT
  ansible.builtin.apt:
    update_cache: yes
  become: yes

- name: Installer les dépendances
  apt:
    name: "{{ item }}"
    state: present
  loop:
    - wget
    - gnupg
    - lsb-release
    - postgresql
    - php
    - php-pgsql
    - acl
    - python3-psycopg2
    - locales
  become: yes


- name: Configurer la locale
  ansible.builtin.command: >
    echo "en_US.UTF-8 UTF-8" | sudo tee -a /etc/locale.gen
  args:
    creates: /etc/locale.gen
  become: yes

- name: Générer la locale
  ansible.builtin.command: >
    sudo locale-gen
  args:
    creates: /etc/locale.gen
  become: yes

- name: Mettre à jour la locale
  ansible.builtin.command: >
    sudo update-locale LANG=en_US.UTF-8
  args:
    creates: /etc/default/locale
  become: yes

- name: Redémarrer Apache 
  ansible.builtin.command: >
    sudo systemctl restart apache2
  args:
    creates: /var/run/apache2/apache2.pid
  become: yes

- name: Ajouter le dépôt Zabbix
  ansible.builtin.command: >
    wget -O /tmp/zabbix-release.deb {{ zabbix_repo_deb }}
  args:
    creates: /tmp/zabbix-release.deb

- name: Installer le dépôt Zabbix
  ansible.builtin.apt:
    deb: /tmp/zabbix-release.deb
    state: present


- name: Installer le serveur Zabbix et l'interface web
  apt:
    name:
      - "{{ zabbix_server_package }}"
      - "{{ zabbix_web_package }}"
    state: present

- name: Configurer la base de données PostgreSQL
  become_user: postgres
  become: yes
  postgresql_db:
    name: "{{ zabbix_db }}"
    state: present




- name: Créer l'utilisateur Zabbix pour PostgreSQL
  become_user: postgres
  postgresql_user:
    name: "{{ zabbix_db_user }}"
    password: "{{ zabbix_db_password }}"
    db: "{{ zabbix_db }}"
    priv: "ALL"

- name: Démarrer et activer le service Zabbix
  ansible.builtin.service:
    name: "{{ item }}"
    state: started
    enabled: true
  loop:
    - zabbix-server
    - apache2
    - postgresql


- name: Vérifier l'état des services Zabbix
  ansible.builtin.service_facts:

- name: Afficher l'état des services
  ansible.builtin.debug:
    var: ansible_facts.services


